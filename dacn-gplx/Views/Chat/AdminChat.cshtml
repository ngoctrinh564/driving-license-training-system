@model List<dacn_gplx.Models.Message>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Chat với học viên";

    // userList giờ là danh sách { UserId, HoTen, Avatar }
    var userList = ViewBag.UserList as IEnumerable<dynamic>;
    int? currentUser = ViewBag.UserId as int?;
    string currentUserName = ViewBag.CurrentUserName as string;

}

<style>
    .chat-box {
        height: 500px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 15px;
    }

    .msg {
        max-width: 75%;
        padding: 10px 14px;
        border-radius: 16px;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .msg-admin {
        background: #0d6efd;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }

    .msg-user {
        background: #e9ecef;
        color: #000;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }

    .msg-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
        text-align: right;
    }

    .user-active {
        background: #0d6efd !important;
        color: #fff !important;
    }

    .unread-badge {
        background: red;
        color: white;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 50%;
        margin-left: auto;
    }

</style>

<div class="row">
    <!-- ================= DANH SÁCH HỌC VIÊN ================= -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                💬 Học viên đang chat
            </div>

            <div class="list-group list-group-flush">
                @if (userList == null || !userList.Any())
                {
                    <div class="text-muted p-3">
                        📭 Chưa có học viên nào
                    </div>
                }
                else
                {
                    foreach (var u in userList)
                    {                       
                        int unread = dacn_gplx.Models.ChatStore.GetUnreadCount((int)u.UserId);                      

                        <a asp-action="AdminChat"
                           asp-route-userId="@u.UserId"
                           class="list-group-item list-group-item-action d-flex align-items-center
                                  @(u.UserId == currentUser ? "user-active" : "")">

                            <div>
                                👤 @u.HoTen
                                <div class="small text-muted">UserID: @u.UserId</div>
                            </div>

                            @if (unread > 0 && u.UserId != currentUser)
                            {
                                <span class="unread-badge">@unread</span>
                            }
                        </a>

                    }
                }
            </div>
        </div>
    </div>

    <!-- ================= KHUNG CHAT ================= -->
    <div class="col-md-8">
        @if (currentUser == null)
        {
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                👈 Chọn học viên bên trái để bắt đầu chat
            </div>
        }
        else
        {
            <div class="card h-100 d-flex flex-column">
                <div class="card-header bg-info text-white">
                    💬 Chat với: @currentUserName
                    <span class="small">(UserID: @currentUser)</span>
                </div>

                <div class="chat-box" id="chatBox">
                    @foreach (var msg in Model)
                    {
                        bool isAdmin = msg.Sender == "Admin";
                        <div class="d-flex">
                            <div class="msg @(isAdmin ? "msg-admin" : "msg-user")">
                                @msg.Content
                                <div class="msg-time">
                                    @msg.Time.ToString("HH:mm dd/MM")
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="card-footer">
                    <div class="d-flex">
                        <input id="message"
                               class="form-control me-2"
                               placeholder="Nhập tin nhắn..." />
                        <button class="btn btn-primary" onclick="sendMessage()">
                            Gửi
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function sendMessage() {
            let content = $("#message").val().trim();
            if (!content) return;

            $.post("@Url.Action("AdminSendMessage", "Chat")",
                {
                    userId: @currentUser,
                    content: content
                },
                function (res) {
                    if (res.success) {
                        $("#message").val("");
                        reloadChat();
                    }
                }
            );
        }

        function reloadChat() {
            $("#chatBox").load(
                "@Url.Action("AdminChat", "Chat", new { userId = currentUser }) #chatBox>*",
                function () {
                    $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
                }
            );
        }

        // Enter để gửi
        $(document).on("keypress", "#message", function (e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        $(document).ready(function () {
            $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
            $("#message").focus();
        });

        setInterval(reloadChat, 5000);
    </script>
}
